# misc04
```
nc misc04.grandprix.whitehatvn.com 1337
```

```
Hint: After get the message "It's a friendly point", you should send the friendly point value.
```

Running this challenge, we get:
```
                   Wellcom to Friendly face challenge
According to experts, the formula for measuring the friendliness of a face is
    (lip point**nose point)**(eyes point**forehead point) mod Face_index
                              Now play!
------------------------------Stage 1--------------------------------------
Face_index: 1910376
Face           Lip point      Nose point     Eyes point     Forehead point 
:-)            472171579      245526306      778201813      669801574      
(';')          679338970      834668040      858879714      34000936       
(=^..^=)       599084933      840017205      898884656      495207986      
:)             478798910      64786568       651228607      757494369      
:-]            645498364      774918305      852709356      318865727      
:]             332549593      601642896      736060684      545686999      
:-3            699244084      9518068        822665489      234986331      
:3             587684706      12120137       811817503      16056778       
:->            775944299      112438703      731894073      481745766      
:>             68279904       632469479      854249392      196630690      
:-*            645935839      37053271       961836002      352910201      
:*             167860437      874406766      220234241      453745468      
(>_<)          509386396      554340574      711233993      887223781      
(>_<)>         122074590      388285198      571273979      54425051       
(';')          469578223      532728053      85029887       774006622      
(^_^;)         575480135      95336616       747381768      334234301      
(-_-;)         130831527      157866451      230914586      200234214      
(~_~;)         185886745      108938474      220290395      441017379      
(...;)         659501449      524818298      380385817      387403551      
(._.;)         751358268      234399870      392373521      748055733      
^_^;           641221977      827845663      490459975      935643688      
(#^.^#)        587185849      637494087      353966186      114704478      
(^^;)          821140492      936882227      180819192      196283007      
(-_-)zzz       82748077       410783960      531031989      481889796      
(^_-)          473368082      592087051      230413767      850571164      
((+_+))        379489212      955808902      861726868      975228818      
(+o+)          764907553      807911749      107945827      308517264      
^_^            327415726      395822790      466224864      287850716      
(^_^)/         343835698      961208320      940536172      318332030      
(=_=)          840865015      275655036      553002272      641006929      
(?_?)          654937828      874713639      778145402      667060976      
(^_^)          784196170      468247968      810156143      331678337      
(~o~)          99534796       810428182      911014718      414652305      
(~_~)          361582850      236356111      123453128      555880186      
o.O            804894993      14479218       521393695      7540311        
(o.o)          18865976       197732552      102728592      674073068      
oO             894494104      414704608      67888964       270807754      
<_<            397874942      114812062      195985271      458911443      
>_>            41212633       439247906      249936778      811273715      
<o?o>          284808834      508854715      30391478       928303561      
(>^.^)         464715139      334663286      273212072      851277560      
(^.^<)         656645029      490655203      864424253      884506104      
>,<            972769460      453562733      726204905      617961607      
;-(            487707624      825492683      810537315      257386009      
>:-(           74173586       527883519      654840887      512189463      
@(-_-)@        401003917      864851408      312136833      344242919      
@(^_^)@        917989104      336751817      382494245      15909642       
~O-O~          160168491      404249070      83450070       251612784      
:)]            400326362      299638021      842403973      797546125      
.-]            60703634       192462955      55106277       628411443      
.-)            835064582      108829683      261045481      579900123      
,-)            112467165      651450045      619089606      578638514      
':-(           229729335      611751911      231365513      841316253      
'-)            740931034      421218756      795645585      595329881      
:-D            849263489      642566767      1238606        917903421      
:=)            554126380      37042841       220747791      524434702      
:@             612947606      78292400       648460361      739983279      
<:-P           836085325      61814546       656057442      783850278      
:)>-           227741728      169613041      201171303      194125645      
:^)            853390753      130916085      985737028      858171516      
3:]            874035312      521122742      274623321      112336034      
(o^-^o)        131790651      905783375      781772455      18318124       
:-<            266727510      985886069      218544590      434321118      
:-[            627603708      75153453       377776791      656472636      
=:-)           453846388      168814867      770139704      130933379      
:-))           214105120      163770547      383796460      346679785      
<(-_-)>        536924739      436113154      996827359      986915060      
9_9            339632665      393230297      113764420      954074173      
=))            460575775      54652612       575262492      933548284      
7:)            747288885      612788967      188000811      150154712      
(<_>)          800400898      104720110      251441254      352503344      
:-(            766298624      605440434      575648311      704955510      
/:-)           433721195      911785844      585479134      943522936      
(-_-)          246865456      624196337      514456703      896725833      
:-*            683427423      982467789      832053984      9129866        
::=))          565655204      231478258      945458486      382413544      
o_o            310988081      340176097      414601880      339364753      
(*^_^*)        268938360      929597094      545277879      921224355      
(-::-)         365499583      426488539      99606922       720847182      
(^o^)          698948942      319896863      230636775      906807191      
:o)            128978585      555382859      974301817      631285262      
:|)            956335064      993866221      630836513      4682841        
:)             212639188      847367037      716903672      530445674      
:-)            701974476      662839305      412117515      703015463      
+:-)           429088040      326169992      700175296      363437792      
(:-)           475746900      607890354      49210303       161199529      
{:-)           872352537      710647907      272310308      578333046      
^&^            443255400      141624483      110075829      672265681      
=.=            683729180      816694677      868440553      289379031      
*~*            646007717      257783410      982228022      536141808      
(:>-<          463624440      28579866       492777903      683307845      
:-)---         166665011      336473876      550427006      984899824      
*-)            160746561      976330202      182629320      45486217       
>:*            326204857      451346174      839472107      938866398      
>.<            9796569        860525966      655349633      593777588      
:-@            708136313      337627063      51514531       280800601      
(:)-)          12791038       122582700      954771377      151670852      
::-)           856704165      232275573      287359857      963523981      
:-@            463661893      876122052      893308839      282651000      
@,.,@          53496571       49328280       910574312      809060770      
:-E            537959122      988217388      799366318      394323922      
:-[            234097376      976486347      98427308       396415122      
:-))           535320202      466074139      551104729      430270022      
:-[]           659817621      292253434      547908071      781499833      
:-)))          126028989      895793563      108316336      727825907      
(:-            39744677       670854831      355547280      813354060      
$_$            330530007      895765538      663855872      864070511      
(^:^)          619603638      861041502      269606277      458495584      
|___|          600890735      914124246      767321199      559909752      
:-)            496399797      968677177      370119609      307255325      
>O<            960585147      542835795      917285682      850195505      
:=)            27997163       914890204      773805604      727152682      
-:-)           483868429      537243361      210601288      590231967      
|:-)           193262044      552563956      668476559      352073321      
<(^.^<)        306999193      423556485      791310668      880235632      
<(*.*<)        684519564      692049460      310087801      697906607      
(*_*)          856204085      426364855      385267862      6352310        
._.            7639159        564820957      583151113      769868809      
@:-)           756737276      123329536      46460728       809721739      
<('.')>        759686793      239694459      150024293      507035859      
<('.'<)        27792318       76694364       848726541      899599128      
<(^.^)>        888073809      810254996      762733346      569185330      
<('.'<)        279779879      655919989      598571338      696461339      
:-*            522596924      830992112      656652607      780518016      
(:-*           363115285      782530498      772865690      446539918      
=^.^=          155643271      567221182      90536686       479954230      
<{::}>         958611065      186919009      47698195       751127912      
:-D            478222476      361577046      673806996      875321338      
:))            428467105      391696223      446815924      770753889      
:.-)           963518383      856469130      613516359      203359918      
(-:            222993493      423924525      807364250      19033544       
>;->           463214454      709473761      69242644       817703963      
:^o            788687545      875089637      651736460      840397926      
:-9            585449224      21009413       907282725      395782652      
So, what is the most friendly face?
```

Clearly, this is an algorithm challenge. If we naively calculate `(lip point**nose point)**(eyes point**forehead point) mod Face_index`, it would take too much time. In addition, numbers are in the range of 10^9, so calculating (10^9 ^ 10^9) ^ (10^9 ^ 10^9) THEN modding simply takes way too many digits. Therefore, there must be some shortcut with modular arithmetic.

Googling this, we stumbled upon this gem: https://stackoverflow.com/questions/4223313/finding-abc-mod-m. At first, it doesn't seem like it has exactly this `(a^b)^(c^d) mod m` format. However, if you read further, you can see they calculate `(p^z)^(b^c) mod m` format, which is exactly the same as ours just with different variable names. Now, it's simply a matter of copying their modpow function and handling input from the challenge. There were a total of 5 stages, but each stage was exactly the same, so I wrapped it around a function and called it 5 times.

Solve script:
```
def totient(n) :          # n - unsigned int
    result = 1
    p = 2                 #prime numbers - 'iterator'
    while p**2 <= n :
        if(n%p == 0) :    # * (p-1)
            result *= (p-1)
            n /= p
        while(n%p == 0) : # * p^(k-1)
            result *=  p
            n /= p
        p += 1
    if n != 1 :
        result *= (n-1)
    return result         # in O(sqrt(n))
def modpow(p, z, b, c, m) : # (p^z)^(b^c) mod m
    cp = 0
    while m % p == 0 :
        cp += 1
        m /= p              # m = m' now
    t = totient(m)
    exponent = ((pow(b,c,t)*z)%t + t - (cp%t))%t
                            # exponent = z*(b^c)-cp mod t
    return pow(p, cp)*pow(p, exponent, m)



from pwn import *

r = remote('misc04.grandprix.whitehatvn.com', 1337)

def solveStage():
	print(r.recvuntil('Face_index: '))
	faceIndex = int(r.recvline())
	r.recvline() # Key

	data = r.recvuntil('So, what is the most friendly face?')
	split = [tuple(x.split()) for x in data.split('\n')[:-1]]

	def func(lipPoint, nosePoint, eyesPoint, foreheadPoint, faceIndex):
		return modpow(lipPoint, nosePoint, eyesPoint, foreheadPoint, faceIndex)

	results = {face: func(int(a), int(b), int(c), int(d), int(faceIndex)) for face, a, b, c, d in split}

	best = max(results, key=results.get)
	r.sendline(best)
	sleep(0.1)
	r.sendline(str(results[best]))

solveStage()
solveStage()
solveStage()
solveStage()
solveStage()
r.interactive()

r.close()
```

